---
import MainGridLayout from "../layouts/MainGridLayout.astro";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";

const pageTitle = i18n(I18nKey.guestbook) || "ç•™è¨€ç‰ˆ";
const pageSubtitle = i18n(I18nKey.guestbookSubtitle) || "ç•™ä¸‹ä½ çš„è¶³è¿¹ï¼Œåˆ†äº«ä½ çš„æƒ³æ³•";
---

<MainGridLayout title={pageTitle} description={pageSubtitle}>
  <!-- Hero -->
  <div class="w-full bg-gradient-to-r from-[var(--primary)] to-[var(--primary-dark)] text-gray-900 dark:text-white py-6 mb-6 rounded-t-[var(--radius-large)]">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h1 class="text-3xl md:text-4xl font-bold leading-tight drop-shadow-sm dark:drop-shadow-md">{pageTitle}</h1>
      <p class="mt-2 opacity-90 text-sm md:text-base drop-shadow-sm dark:drop-shadow-md">{pageSubtitle}</p>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl mx-auto">

        <div class="visitorbook-header mb-6">
          <h2 class="text-xl md:text-2xl font-bold text-90 mb-2">ğŸ’¬ ç•™è¨€æ¿</h2>
          <p class="subtitle text-sm md:text-base text-75 mb-3">æ¬¢è¿æ¥åˆ°ç•™è¨€æ¿ï¼è¿™é‡Œæ˜¯ä¸€ä¸ªè‡ªç”±äº¤æµçš„ç©ºé—´ï¼Œä½ å¯ä»¥ï¼š</p>

          <ul class="features-list space-y-2 mb-4 list-none">
            <li class="text-75 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> åˆ†äº«ä½ çš„æƒ³æ³•å’Œè§‚ç‚¹</li>
            <li class="text-75 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> ç•™ä¸‹ä½ çš„å»ºè®®å’Œåé¦ˆ</li>
            <li class="text-75 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> è®°å½•ä½ çš„å¿ƒæƒ…å’Œæ•…äº‹</li>
            <li class="text-75 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> ä¸å…¶ä»–è®¿å®¢äº’åŠ¨äº¤æµ</li>
          </ul>

          <p class="welcome-text text-75">æ— è®ºä½ æƒ³è¯´ä»€ä¹ˆï¼Œéƒ½æ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€ï¼</p>
        </div>

        <div class="notice-section mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--line-divider)]">
          <h3 class="notice-title text-base font-semibold text-90 mb-2">æ¸©é¦¨æç¤ºï¼š</h3>
          <ul class="notice-list space-y-1 text-sm text-75 list-none">
            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> è¯·ä¿æŒå‹å–„å’Œå°Šé‡ï¼Œè¥é€ è‰¯å¥½çš„äº¤æµæ°›å›´</li>
            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> æ¬¢è¿åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿå¯ä»¥æå‡ºå¯¹ç½‘ç«™çš„å»ºè®®</li>
            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> ä½ çš„æ¯ä¸€æ¡ç•™è¨€éƒ½æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ âœ¨</li>
          </ul>
        </div>

        <div class="divider h-px bg-gradient-to-r from-transparent via-[var(--line-divider)] to-transparent my-6"></div>

        <!-- Twikoo è¯„è®ºå®¹å™¨ -->
        <div id="twikoo" class="w-full mt-4"></div>

      </div>
    </div>
  </div>
</MainGridLayout>

<!-- åªä¿ç•™ä¸€æ¬¡ SDK å¼•å…¥ï¼Œå›ºå®šç‰ˆæœ¬ï¼Œé¿å… latest å¸¦æ¥çš„ä¸ç¡®å®šæ€§ -->
<script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.all.min.js" defer crossorigin="anonymous" is:inline data-swup-reload-script></script>

<!-- åˆå§‹åŒ–ï¼ˆå…¼å®¹ Astro å®¢æˆ·ç«¯å¯¼èˆªï¼‰ -->
<script is:inline data-swup-reload-script>
  (function () {
    // æ³¨æ„ï¼šä¸è¦å¸¦æœ«å°¾æ–œæ 
    var ENV_ID = "https://twikoo-api-gmgc.vercel.app";

    // ç”Ÿæˆç¨³å®š pathï¼Œé¿å…æœ«å°¾æ–œæ é€ æˆåˆ†èº«
    function getStablePath() {
      var p = window.location.pathname || "/";
      if (p.length > 1 && p.endsWith("/")) p = p.slice(0, -1);
      return p || "/";
    }

    // å¯é‡å¤è°ƒç”¨çš„åˆå§‹åŒ–
    function initTwikoo() {
      var container = document.getElementById("twikoo");
      if (!container) return;

      // æ¸…ç©ºå®¹å™¨ï¼Œé¿å…é‡å¤æŒ‚è½½
      container.innerHTML = "";

      try {
        if (window.twikoo && window.twikoo.init) {
          window.twikoo.init({
            envId: ENV_ID,
            el: "#twikoo",
            path: getStablePath(),
            lang: "zh-CN"
          });
        }
      } catch (err) {
        console.error("[Twikoo] init error:", err);
      }
    }

    // ç­‰å¾… SDK å¯ç”¨å†æ‰§è¡Œåˆå§‹åŒ–ï¼ˆè§£å†³é¦–æ¬¡è¿›å…¥æˆ–åˆ‡é¡µæ—¶åºé—®é¢˜ï¼‰
    function whenTwikooReady(cb) {
      if (window.twikoo && window.twikoo.init) {
        cb();
        return;
      }
      var tries = 0;
      var t = setInterval(function () {
        if (window.twikoo && window.twikoo.init) {
          clearInterval(t);
          cb();
        } else if (++tries > 200) {
          clearInterval(t);
          console.error("[Twikoo] SDK failed to load");
        }
      }, 50);
    }

    function scheduleInitTry(timesLeft) {
      var container = document.getElementById("twikoo");
      if (container) {
        whenTwikooReady(initTwikoo);
        return;
      }
      if (timesLeft > 0) {
        setTimeout(function () { scheduleInitTry(timesLeft - 1); }, 120);
      }
    }

    function boot() {
      scheduleInitTry(30);
    }

    // é¦–æ¬¡è¿›å…¥é¡µé¢
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", boot, { once: true });
    } else {
      boot();
    }

    // Astro å®¢æˆ·ç«¯å¯¼èˆªï¼šæ¯æ¬¡è¿›å…¥é¡µé¢é‡æ–°åˆå§‹åŒ–ï¼ˆå…ˆç­‰å¾… SDKï¼‰
    if (typeof window !== "undefined") {
      window.addEventListener("astro:page-load", function () { boot(); });
      document.addEventListener("swup:contentReplaced", function () { boot(); });
      document.addEventListener("swup:pageView", function () { boot(); });
      document.addEventListener("swup:animationInDone", function () { boot(); });
      if (window.swup && window.swup.hooks && typeof window.swup.hooks.on === "function") {
        window.swup.hooks.on("content:replace", function () { boot(); });
        window.swup.hooks.on("page:view", function () { boot(); });
        window.swup.hooks.on("animation:in:end", function () { boot(); });
      }
    }
  })();
</script>

<style>
  .visitorbook-header h2 {
    text-align: left;
  }
  .features-list,
  .notice-list {
    list-style: none;
    padding-left: 0;
  }
  .emoji {
    font-size: 1rem;
  }
  #twikoo {
    min-height: 300px;
  }
  @media (max-width: 640px) {
    .card-base {
      margin: 0 -0.5rem;
      border-radius: 0;
    }
  }
</style>
