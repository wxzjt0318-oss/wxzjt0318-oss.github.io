---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/700.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import MusicPlayer from "@components/widget/MusicPlayer.svelte";
import Pio from "@components/widget/Pio.svelte"; // 使用 Svelte 版本的 Pio 组件
import {
    musicPlayerConfig,
    pioConfig,
    profileConfig,
    siteConfig,
} from "@/config";
import { umamiConfig } from "../config";

const BANNER_HEIGHT = 35;
const BANNER_HEIGHT_EXTEND = 30;
const BANNER_HEIGHT_HOME = BANNER_HEIGHT + BANNER_HEIGHT_EXTEND;

import {
    DARK_MODE,
    DEFAULT_THEME,
    LIGHT_MODE,
    PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";

import "katex/dist/katex.css";
import "../styles/mobile-navbar.css";
import "../styles/wallpaper-navbar-transparent.css";
import "../styles/fancybox-custom.css";
import "../styles/expressive-code.css";
import "../styles/panel-animations.css";

interface Props {
    title?: string;
    banner?: string;
    description?: string;
    lang?: string;
    setOGTypeArticle?: boolean;
    postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } =
    Astro.props;

const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
    siteConfig.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
const shouldShowTopHighlight =
    navbarTransparentMode === "full" || navbarTransparentMode === "semifull";

// 获取默认banner图片的辅助函数
const getDefaultBanner = (): string => {
    const src = siteConfig.banner.src;
    if (typeof src === "string") {
        return src;
    }
    if (Array.isArray(src)) {
        return src[0] || "";
    }
    if (src && typeof src === "object") {
        const desktopSrc = src.desktop;
        const mobileSrc = src.mobile;
        if (typeof desktopSrc === "string") {
            return desktopSrc;
        }
        if (Array.isArray(desktopSrc) && desktopSrc.length > 0) {
            return desktopSrc[0];
        }
        if (typeof mobileSrc === "string") {
            return mobileSrc;
        }
        if (Array.isArray(mobileSrc) && mobileSrc.length > 0) {
            return mobileSrc[0];
        }
    }
    return "";
};

if (!banner || typeof banner !== "string" || banner.trim() === "") {
    banner = getDefaultBanner();
}

// TODO don't use post cover as banner for now
banner = getDefaultBanner();

const enableBanner = !!siteConfig.banner.src;

let pageTitle: string;
if (title) {
    pageTitle = `${title} - ${siteConfig.title}`;
} else {
    pageTitle = siteConfig.subtitle
        ? `${siteConfig.title} - ${siteConfig.subtitle}`
        : siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
    ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
    siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

if (!lang) {
    lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
    top: `${BANNER_HEIGHT_EXTEND}vh`,
    center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
    bottom: "0",
};
const bannerOffset =
    bannerOffsetByPosition[siteConfig.banner.position || "center"];

const umamiEnabled = umamiConfig.enabled || false;
const umamiScripts = umamiConfig.scripts || "";

// 构建字体配置的 CSS 变量
let bodyFontFamily = "";
if (siteConfig.font) {
    const fonts: string[] = [];

    if (siteConfig.font.asciiFont?.fontFamily) {
        const asciiFont = siteConfig.font.asciiFont.fontFamily;
        fonts.push(asciiFont.includes(" ") ? `"${asciiFont}"` : asciiFont);
    }

    if (siteConfig.font.cjkFont?.fontFamily) {
        const cjkFont = siteConfig.font.cjkFont.fontFamily;
        fonts.push(cjkFont.includes(" ") ? `"${cjkFont}"` : cjkFont);
    }

    fonts.push(
        "system-ui",
        "-apple-system",
        "BlinkMacSystemFont",
        "'Segoe UI'",
        "Roboto",
        "Oxygen",
        "Ubuntu",
        "Cantarell",
        "'Open Sans'",
        "'Helvetica Neue'",
        "sans-serif",
    );

    bodyFontFamily = fonts.join(", ");
}

/* ---------- Favicon cache-busting helpers ---------- */
const FAVICON_VERSION =
    (import.meta.env.PUBLIC_FAVICON_VERSION as string | undefined) ??
    Math.floor(Date.now() / 1000).toString();

const appendVersion = (href: string) => {
    if (!FAVICON_VERSION) return href;
    const hasQuery = href.includes("?");
    return `${href}${hasQuery ? "&" : "?"}v=${FAVICON_VERSION}`;
};

const inferIconType = (href: string) => {
    const lower = href.toLowerCase();
    if (lower.endsWith(".svg")) return "image/svg+xml";
    if (lower.endsWith(".png")) return "image/png";
    if (lower.endsWith(".ico")) return "image/x-icon";
    return undefined;
};
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]"
      data-overlayscrollbars-initialize
>
    <head>
        <!-- 第三方分析脚本 - 延迟加载优化 -->
        <script is:inline>
            function loadAnalytics() {
                (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KRX3XGVH');
                (function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "tjr3vkhj8i");
            }
            if ('requestIdleCallback' in window) {
                requestIdleCallback(loadAnalytics, { timeout: 3000 });
            } else {
                setTimeout(loadAnalytics, 3000);
            }
        </script>

        <title>{pageTitle}</title>

        <meta charset="UTF-8" />
        <meta name="description" content={description || pageTitle}>
        {siteConfig.keywords && siteConfig.keywords.length > 0 && (
            <meta name="keywords" content={siteConfig.keywords.join(', ')} />
        )}
        <meta name="author" content={profileConfig.name}>

        <meta property="og:site_name" content={siteConfig.title}>
        <meta property="og:url" content={Astro.url}>
        <meta property="og:title" content={pageTitle}>
        <meta property="og:description" content={description || pageTitle}>
        {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
        {
            setOGTypeArticle ? (
                <meta property="og:type" content="article" />
            ) : (
                <meta property="og:type" content="website" />
            )
        }

        <meta name="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content={Astro.url}>
        <meta name="twitter:title" content={pageTitle}>
        <meta name="twitter:description" content={description || pageTitle}>

        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />

        {/*
          Favicon 渲染：
          - 统一追加 ?v=... 强制刷新缓存
          - 自动推断 type
          - .ico 默认 sizes="any"
        */}

        <!-- 显式根路径 ICO（放在自定义映射之前，保证命中） -->
        <link
            rel="icon"
            href={appendVersion(url('/favicon.ico'))}
            sizes="any"
            type="image/x-icon"
        />
        <link
            rel="shortcut icon"
            href={appendVersion(url('/favicon.ico'))}
            type="image/x-icon"
        />

        {favicons.map(favicon => {
            const baseHref = favicon.src.startsWith('/') ? url(favicon.src) : favicon.src;
            const href = appendVersion(baseHref);
            const type = inferIconType(baseHref);
            const isIco = (baseHref || "").toLowerCase().endsWith(".ico");
            return (
                <link
                    rel="icon"
                    href={href}
                    sizes={favicon.sizes || (isIco ? "any" : undefined)}
                    media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
                    type={type}
                />
            );
        })}

        <!-- Set the theme before the page is rendered to avoid a flash -->
        <script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
            const theme = localStorage.getItem('theme') || DEFAULT_THEME;
            let isDark = false;
            switch (theme) {
                case LIGHT_MODE:
                    document.documentElement.classList.remove('dark');
                    isDark = false;
                    break
                case DARK_MODE:
                    document.documentElement.classList.add('dark');
                    isDark = true;
                    break
            }
            const expressiveTheme = isDark ? "github-dark" : "github-light";
            const currentTheme = document.documentElement.getAttribute("data-theme");
            if (currentTheme !== expressiveTheme) {
                document.documentElement.setAttribute("data-theme", expressiveTheme);
            }
            const hue = localStorage.getItem('hue') || configHue;
            document.documentElement.style.setProperty('--hue', hue);
            let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
            offset = offset - offset % 4;
            document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
        </script>
        <style define:vars={{
            configHue,
            'page-width': `${PAGE_WIDTH}rem`,
        }}></style>

        <slot name="head"></slot>

        {pioConfig.enable && <link rel="stylesheet" href="/pio/static/pio.css" />}

        <link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

        <!-- Umami Analytics -->
        {umamiEnabled && umamiScripts && <Fragment set:html={umamiScripts} />}

</head>
    <body class=" min-h-screen " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
          style={bodyFontFamily ? `font-family: ${bodyFontFamily};` : ''}
          data-overlayscrollbars-initialize
    >
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KRX3XGVH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        
        {shouldShowTopHighlight && <div class="top-gradient-highlight"></div>}
        <ConfigCarrier></ConfigCarrier>
        <slot />
        
        {musicPlayerConfig.enable && <MusicPlayer client:load />}
        {pioConfig.enable && <Pio client:load />}
        
        <div id="page-height-extend" class="hidden h-[300vh]"></div>
    </body>
</html>

<style is:global define:vars={{
    bannerOffset,
    'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
    'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
    .enable-banner.is-home #banner-wrapper {
        @apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
    }
    .enable-banner #banner-wrapper {
        @apply h-[var(--banner-height-home)]
    }

    .enable-banner.is-home #banner {
        @apply h-[var(--banner-height-home)] translate-y-0
    }
    .enable-banner #banner {
        @apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
    }
    .enable-banner.is-home #main-grid {
        @apply translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #top-row {
        @apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
    }
    .enable-banner.is-home #sidebar-sticky {
        @apply top-[calc(1rem_-_var(--banner-height-extend))]
    }
    .navbar-hidden {
        @apply opacity-0 -translate-y-16
    }
    
    .waves > .parallax use {
        animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
    }

    @keyframes wave {
        0% {
            transform: translate3d(-90px, 0, 0);
        }
        100% {
            transform: translate3d(85px, 0, 0);
        }
    }
}
</style>

<script>
import 'overlayscrollbars/overlayscrollbars.css';
import {pathsEqual, url} from "../utils/url-utils";
import {
    DARK_MODE,
    DEFAULT_THEME
} from "../constants/constants";

const BANNER_HEIGHT = 35;
const BANNER_HEIGHT_EXTEND = 30;
const BANNER_HEIGHT_HOME = BANNER_HEIGHT + BANNER_HEIGHT_EXTEND;
import { siteConfig } from '../config';
import { widgetConfigs } from "../config";
import { initSakura } from "../utils/sakura-manager";

// @ts-ignore
const setTimeout = (callback: any, delay: any) => window.setTimeout(callback, delay);

function initCustomScrollbar() {
    const katexElements = document.querySelectorAll('.katex-display:not([data-scrollbar-initialized])') as NodeListOf<HTMLElement>;
    katexElements.forEach(element => {
        if (!element.parentNode) return;

        const container = document.createElement('div');
        container.className = 'katex-display-container';
        element.parentNode.insertBefore(container, element);
        container.appendChild(element);

        container.style.cssText = `
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.3) transparent;
        `;
        
        const style = document.createElement('style');
        style.textContent = `
            .katex-display-container::-webkit-scrollbar {
                height: 6px;
            }
            .katex-display-container::-webkit-scrollbar-track {
                background: transparent;
            }
            .katex-display-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
            }
            .katex-display-container::-webkit-scrollbar-thumb:hover {
                background: rgba(0,0,0,0.5);
            }
        `;
        if (!document.head.querySelector('style[data-katex-scrollbar]')) {
            style.setAttribute('data-katex-scrollbar', 'true');
            document.head.appendChild(style);
        }

        element.setAttribute('data-scrollbar-initialized', 'true');
    });
}

function showBanner() {
    requestAnimationFrame(() => {
        const banner = document.getElementById('banner');
        if (banner) {
            banner.classList.remove('opacity-0', 'scale-105');
        }

        const mobileBanner = document.querySelector('.block.lg\\:hidden[alt="Mobile banner image of the blog"]');
        if (mobileBanner && !document.getElementById('banner-carousel')) {
            mobileBanner.classList.remove('opacity-0', 'scale-105');
            mobileBanner.classList.add('opacity-100');
        }

        const carousel = document.getElementById('banner-carousel');
        if (carousel) {
            initCarousel();
        }
    });
}

function initCarousel() {
    const carouselItems = document.querySelectorAll('.carousel-item');
    const isMobile = window.innerWidth < 1024;
    const validItems = Array.from(carouselItems).filter(item => {
        if (isMobile) {
            return item.querySelector('.block.lg\\:hidden');
        } else {
            return item.querySelector('.hidden.lg\\:block');
        }
    });
    
    if (validItems.length > 1 && !siteConfig.banner.carousel?.enable) {
        carouselItems.forEach((item) => {
            item.classList.add('opacity-0', 'scale-110');
            item.classList.remove('opacity-100', 'scale-100');
        });
        const randomIndex = Math.floor(Math.random() * validItems.length);
        const randomItem = validItems[randomIndex];
        randomItem.classList.add('opacity-100', 'scale-100');
        randomItem.classList.remove('opacity-0', 'scale-110');
        return;
    }
    
    if (validItems.length > 1 && siteConfig.banner.carousel?.enable) {
        let currentIndex = 0;
        const interval = siteConfig.banner.carousel?.interval || 6;
        let carouselInterval;
        let isPaused = false;

        let startX = 0;
        let startY = 0;
        let isSwiping = false;
        const carousel = document.getElementById('banner-carousel');

        function switchToSlide(index) {
            const currentItem = validItems[currentIndex];
            currentItem.classList.remove('opacity-100', 'scale-100');
            currentItem.classList.add('opacity-0', 'scale-110');

            currentIndex = index;
            const nextItem = validItems[currentIndex];
            nextItem.classList.add('opacity-100', 'scale-100');
            nextItem.classList.remove('opacity-0', 'scale-110');
        }

        carouselItems.forEach((item) => {
            item.classList.add('opacity-0', 'scale-110');
            item.classList.remove('opacity-100', 'scale-100');
        });
        if (validItems.length > 0) {
            validItems[0].classList.add('opacity-100', 'scale-100');
            validItems[0].classList.remove('opacity-0', 'scale-110');
        }

        if (carousel && 'ontouchstart' in window) {
            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwiping = false;
                isPaused = true;
                clearInterval(carouselInterval);
            }, { passive: true });

            carousel.addEventListener('touchmove', (e) => {
                if (!startX || !startY) return;
                const diffX = Math.abs(e.touches[0].clientX - startX);
                const diffY = Math.abs(e.touches[0].clientY - startY);
                if (diffX > diffY && diffX > 30) {
                    isSwiping = true;
                    e.preventDefault();
                }
            }, { passive: false });

            carousel.addEventListener('touchend', (e) => {
                if (!startX || !startY || !isSwiping) {
                    isPaused = false;
                    startCarousel();
                    return;
                }
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                if (Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        const nextIndex = (currentIndex + 1) % validItems.length;
                        switchToSlide(nextIndex);
                    } else {
                        const prevIndex = (currentIndex - 1 + validItems.length) % validItems.length;
                        switchToSlide(prevIndex);
                    }
                }
                startX = 0;
                startY = 0;
                isSwiping = false;
                isPaused = false;
                startCarousel();
            }, { passive: true });
        }

        function startCarousel() {
            clearInterval(carouselInterval);
            carouselInterval = setInterval(() => {
                if (!isPaused) {
                    const nextIndex = (currentIndex + 1) % validItems.length;
                    switchToSlide(nextIndex);
                }
            }, interval * 1000);
        }

        if (carousel) {
            carousel.addEventListener('mouseenter', () => {
                isPaused = true;
                clearInterval(carouselInterval);
            });
            carousel.addEventListener('mouseleave', () => {
                isPaused = false;
                startCarousel();
            });
        }

        startCarousel();
    }
}

function setupSakura() {
    const sakuraConfig = (widgetConfigs as any)?.sakura;
    if (!sakuraConfig || !sakuraConfig.enable) return;
    if ((window as any).sakuraInitialized) return;
    initSakura(sakuraConfig);
    (window as any).sakuraInitialized = true;
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupSakura);
} else {
    setupSakura();
}

const setup = () => {
    window.swup.hooks.on('link:click', () => {
        document.documentElement.style.setProperty('--content-delay', '0ms')
        const bannerEnabled = !!document.getElementById('banner-wrapper')
        if (bannerEnabled) {
            const navbar = document.getElementById('navbar-wrapper')
            if (navbar && document.body.classList.contains('lg:is-home')) {
                const threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 88
                if (document.documentElement.scrollTop >= threshold) {
                    navbar.classList.add('navbar-hidden')
                }
            }
        }
    })
    window.swup.hooks.on('content:replace', () => {
        initCustomScrollbar();
        const tocWrapper = document.getElementById('toc-wrapper');
        const isArticlePage = tocWrapper !== null;
        if (isArticlePage) {
            const tocElement = document.querySelector('table-of-contents');
            if (tocElement && typeof (tocElement as any).init === 'function') {
                setTimeout(() => {
                    (tocElement as any).init();
                }, 100);
            }
            if (typeof (window as any).mobileTOCInit === 'function') {
                setTimeout(() => {
                    (window as any).mobileTOCInit();
                }, 100);
            }
        }
        const navbar = document.getElementById('navbar')
        if (navbar) {
            const transparentMode = navbar.getAttribute('data-transparent-mode')
            if (transparentMode === 'semifull') {
                if (typeof (window as any).initSemifullScrollDetection === 'function') {
                    (window as any).initSemifullScrollDetection()
                }
            }
        }
    })
    window.swup.hooks.on('visit:start', (visit) => {
        const bodyElement = document.querySelector('body')
        const isHomePage = pathsEqual(visit.to.url, url('/'))
        if (isHomePage) {
            bodyElement.classList.add('lg:is-home');
        } else {
            bodyElement.classList.remove('lg:is-home');
        }

        const bannerTextOverlay = document.querySelector('.banner-text-overlay')
        if (bannerTextOverlay) {
            if (isHomePage) {
                bannerTextOverlay.classList.remove('hidden')
            } else {
                bannerTextOverlay.classList.add('hidden')
            }
        }

        const navbar = document.getElementById('navbar')
        if (navbar) {
            navbar.setAttribute('data-is-home', isHomePage.toString())
            const transparentMode = navbar.getAttribute('data-transparent-mode')
            if (transparentMode === 'semifull') {
                if (typeof window.initSemifullScrollDetection === 'function') {
                    window.initSemifullScrollDetection()
                }
            }
        }

        const bannerWrapper = document.getElementById('banner-wrapper')
        const mainContentWrapper = document.querySelector('.absolute.w-full.z-30')
        if (bannerWrapper && mainContentWrapper) {
            if (isHomePage) {
                setTimeout(() => {
                    bannerWrapper.classList.remove('mobile-hide-banner')
                }, 100)
                setTimeout(() => {
                    mainContentWrapper.classList.remove('mobile-main-no-banner')
                }, 150)
            } else {
                bannerWrapper.classList.add('mobile-hide-banner')
                setTimeout(() => {
                    mainContentWrapper.classList.add('mobile-main-no-banner')
                }, 100)
            }
        }

        const heightExtend = document.getElementById('page-height-extend')
        if (heightExtend) {
            heightExtend.classList.remove('hidden')
        }

        let toc = document.getElementById('toc-wrapper');
        if (toc) {
            toc.classList.add('toc-not-ready')
        }
    });
    window.swup.hooks.on('page:view', () => {
        const heightExtend = document.getElementById('page-height-extend')
        if (heightExtend) {
            heightExtend.classList.remove('hidden')
        }
        window.scrollTo({ top: 0, behavior: 'instant' });
        const storedTheme = localStorage.getItem('theme') || DEFAULT_THEME;
        const isDark = storedTheme === DARK_MODE;
        const expectedTheme = isDark ? 'github-dark' : 'github-light';
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const hasDarkClass = document.documentElement.classList.contains('dark');
        if (currentTheme !== expectedTheme || hasDarkClass !== isDark) {
            requestAnimationFrame(() => {
                if (currentTheme !== expectedTheme) {
                    document.documentElement.setAttribute('data-theme', expectedTheme);
                }
                if (hasDarkClass !== isDark) {
                    if (isDark) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
        }
        setTimeout(() => {
            if (document.getElementById('tcomment')) {
                const pageLoadedEvent = new CustomEvent('mizuki:page:loaded', {
                    detail: { path: window.location.pathname, timestamp: Date.now() }
                });
                document.dispatchEvent(pageLoadedEvent);
                console.log('Layout: 触发 mizuki:page:loaded 事件，路径:', window.location.pathname);
            }
        }, 300);
    });
    window.swup.hooks.on('visit:end', () => {
        setTimeout(() => {
            const heightExtend = document.getElementById('page-height-extend')
            if (heightExtend) {
                heightExtend.classList.add('hidden')
            }
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
    });
}
if (window?.swup?.hooks) {
    setup()
} else {
    document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')

function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

function scrollFunction() {
    const scrollTop = document.documentElement.scrollTop;
    const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

    requestAnimationFrame(() => {
        if (backToTopBtn) {
            if (scrollTop > bannerHeight) {
                backToTopBtn.classList.remove('hide')
            } else {
                backToTopBtn.classList.add('hide')
            }
        }

        if (document.getElementById('banner-wrapper') && toc) {
            if (scrollTop > bannerHeight) {
                toc.classList.remove('toc-hide')
            } else {
                toc.classList.add('toc-hide')
            }
        }

        if (document.getElementById('banner-wrapper') && navbar) {
            const isHome = document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024;
            const currentBannerHeight = isHome ? BANNER_HEIGHT_HOME : BANNER_HEIGHT;
            const threshold = window.innerHeight * (currentBannerHeight / 100) - 88;
            if (scrollTop >= threshold) {
                navbar.classList.add('navbar-hidden')
            } else {
                navbar.classList.remove('navbar-hidden')
            }
        }
    });
}

window.onscroll = throttle(scrollFunction, 16);

window.onresize = () => {
    let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
    offset = offset - offset % 4;
    document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
        showBanner();
        try {
            await import('../utils/panel-manager.js');
            console.log('Panel manager initialized');
        } catch (error) {
            console.error('Failed to initialize panel manager:', error);
        }
    });
} else {
    showBanner();
    (async () => {
        try {
            await import('../utils/panel-manager.js');
            console.log('Panel manager initialized');
        } catch (error) {
            console.error('Failed to initialize panel manager:', error);
        }
    })();
}

</script>

<!-- 代码块折叠功能 -->
<script>
import '../scripts/code-collapse.js';
</script>

<!-- 主题切换综合性能优化器 -->
<script>
import '../scripts/theme-optimizer.js';
</script>

<script>
import { Fancybox } from "@fancyapps/ui";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

let fancyboxSelectors = [];

function initFancybox() {
  if (fancyboxSelectors.length > 0) {
    return;
  }
  const commonConfig = {
    Thumbs: { autoStart: true, showOnStart: "yes" },
    Toolbar: {
      display: {
        left: ["infobar"],
        middle: ["zoomIn","zoomOut","toggle1to1","rotateCCW","rotateCW","flipX","flipY"],
        right: ["slideshow", "thumbs", "close"],
      },
    },
    animated: true,
    dragToClose: true,
    keyboard: {
      Escape: "close",
      Delete: "close",
      Backspace: "close",
      PageUp: "next",
      PageDown: "prev",
      ArrowUp: "next",
      ArrowDown: "prev",
      ArrowRight: "next",
      ArrowLeft: "prev",
    },
    fitToView: true,
    preload: 3,
    infinite: true,
    Panzoom: { maxScale: 3, minScale: 1 },
    caption: false
  };

  const albumImagesSelector = ".custom-md img, #post-cover img, .moment-images img";
  Fancybox.bind(albumImagesSelector, {
    ...commonConfig,
    groupAll: true,
    Carousel: { transition: "slide", preload: 2 },
  });
  fancyboxSelectors.push(albumImagesSelector);

  const albumLinksSelector = ".moment-images a[data-fancybox]";
  Fancybox.bind(albumLinksSelector, {
    ...commonConfig,
    source: (el) => el.getAttribute("data-src") || el.getAttribute("href"),
  });
  fancyboxSelectors.push(albumLinksSelector);

  const singleFancyboxSelector = "[data-fancybox]:not(.moment-images a)";
  Fancybox.bind(singleFancyboxSelector, commonConfig);
  fancyboxSelectors.push(singleFancyboxSelector);
}

function cleanupFancybox() {
  fancyboxSelectors.forEach(selector => {
    Fancybox.unbind(selector);
  });
  fancyboxSelectors = [];
}

const setup = () => {
  initFancybox();
  window.swup.hooks.on("page:view", () => {
    cleanupFancybox();
    requestAnimationFrame(() => {
      initFancybox();
    });
  });
}

if (window.swup) {
  setup()
} else {
  document.addEventListener("swup:enable", setup)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initFancybox);
  } else {
    initFancybox();
  }
}
</script>
